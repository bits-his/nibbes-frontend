import { useState, useEffect, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Search, RefreshCw, DollarSign, CheckCircle, XCircle, Clock, AlertCircle } from \"lucide-react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n  DialogFooter,\n} from \"@/components/ui/dialog\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { getWebSocketUrl } from \"@/lib/websocket\";\n\ninterface Order {\n  id: number;\n  orderNumber: number;\n  customerName: string;\n  customerPhone: string;\n  orderType: string;\n  paymentMethod: string;\n  paymentStatus: string;\n  status: string;\n  total: string;\n  createdAt: string;\n  items: OrderItem[];\n}\n\ninterface OrderItem {\n  id: number;\n  menuItemId: number;\n  quantity: number;\n  price: string;\n  specialInstructions?: string;\n  menuItem: {\n    name: string;\n    imageUrl?: string;\n  };\n}\n\ninterface Refund {\n  id: number;\n  orderId: number;\n  orderNumber: number;\n  amount: string;\n  reason: string;\n  status: 'pending' | 'approved' | 'rejected' | 'completed';\n  requestedBy: string;\n  processedBy?: string;\n  createdAt: string;\n  updatedAt: string;\n  order?: Order;\n}\n\nexport default function RefundManagement() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [searchQuery, setSearchQuery] = useState<string>(\"\");\n  const [selectedStatus, setSelectedStatus] = useState<string>(\"All\");\n  const [selectedRefund, setSelectedRefund] = useState<Refund | null>(null);\n  const [showRefundDialog, setShowRefundDialog] = useState(false);\n  const [refundReason, setRefundReason] = useState(\"\");\n  const [processingRefund, setProcessingRefund] = useState(false);\n\n  // Fetch refunds\n  const { data: refunds, isLoading, refetch } = useQuery<Refund[]>({\n    queryKey: [\"/api/refunds\"],\n    staleTime: 0,\n    refetchOnWindowFocus: false,\n    refetchOnMount: true,\n  });\n\n  // Status filter options\n  const statusFilters = [\"All\", \"Pending\", \"Approved\", \"Rejected\", \"Completed\"];\n\n  // Filter refunds based on search and status\n  const filteredRefunds = useMemo(() => {\n    if (!refunds) return [];\n    \n    return refunds.filter((refund) => {\n      const matchesStatus = selectedStatus === \"All\" || refund.status.toLowerCase() === selectedStatus.toLowerCase();\n      const matchesSearch = searchQuery === \"\" || \n        refund.orderNumber.toString().includes(searchQuery) ||\n        refund.order?.customerName.toLowerCase().includes(searchQuery.toLowerCase()) ||\n        refund.order?.customerPhone.includes(searchQuery);\n      \n      return matchesStatus && matchesSearch;\n    });\n  }, [refunds, selectedStatus, searchQuery]);\n\n  // Handle refund approval\n  const handleApproveRefund = async (refundId: number) => {\n    try {\n      setProcessingRefund(true);\n      const response = await apiRequest(\"POST\", `/api/refunds/${refundId}/approve`, {});\n      \n      if (!response.ok) {\n        throw new Error(\"Failed to approve refund\");\n      }\n      \n      toast({\n        title: \"Refund Approved\",\n        description: \"The refund has been approved successfully.\",\n      });\n      \n      refetch();\n      setShowRefundDialog(false);\n      setSelectedRefund(null);\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to approve refund. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setProcessingRefund(false);\n    }\n  };\n\n  // Handle refund rejection\n  const handleRejectRefund = async (refundId: number, reason: string) => {\n    if (!reason.trim()) {\n      toast({\n        title: \"Reason Required\",\n        description: \"Please provide a reason for rejecting the refund.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    try {\n      setProcessingRefund(true);\n      const response = await apiRequest(\"POST\", `/api/refunds/${refundId}/reject`, {\n        reason: reason,\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Failed to reject refund\");\n      }\n      \n      toast({\n        title: \"Refund Rejected\",\n        description: \"The refund has been rejected.\",\n      });\n      \n      refetch();\n      setShowRefundDialog(false);\n      setSelectedRefund(null);\n      setRefundReason(\"\");\n    } catch (error) {\n      toast({\n        title: \"Error\",\n        description: \"Failed to reject refund. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setProcessingRefund(false);\n    }\n  };\n\n  // WebSocket connection for real-time updates\n  useEffect(() => {\n    const wsUrl = getWebSocketUrl();\n    const socket = new WebSocket(wsUrl);\n\n    socket.onopen = () => {\n      console.log(\"âœ… Refund Management WebSocket connected\");\n    };\n\n    socket.onmessage = (event) => {\n      const data = JSON.parse(event.data);\n      console.log('ðŸ“¨ [Refund Management] WebSocket message:', data.type);\n      \n      if (data.type === \"refund_update\" || data.type === \"new_refund\") {\n        console.log(\"ðŸ”„ Refund updated - refreshing list\");\n        queryClient.invalidateQueries({ queryKey: [\"/api/refunds\"] });\n        refetch();\n      }\n    };\n\n    socket.onerror = (error) => {\n      console.error(\"âŒ Refund Management WebSocket error:\", error);\n    };\n\n    socket.onclose = () => {\n      console.log(\"ðŸ”Œ Refund Management WebSocket disconnected\");\n    };\n\n    return () => {\n      socket.close();\n    };\n  }, [refetch]);\n\n  // Get status badge variant\n  const getStatusBadge = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'pending':\n        return <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800\"><Clock className=\"w-3 h-3 mr-1\" />Pending</Badge>;\n      case 'approved':\n        return <Badge variant=\"secondary\" className=\"bg-blue-100 text-blue-800\"><CheckCircle className=\"w-3 h-3 mr-1\" />Approved</Badge>;\n      case 'completed':\n        return <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800\"><CheckCircle className=\"w-3 h-3 mr-1\" />Completed</Badge>;\n      case 'rejected':\n        return <Badge variant=\"destructive\"><XCircle className=\"w-3 h-3 mr-1\" />Rejected</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"flex flex-col h-screen overflow-hidden\">\n        {/* Header Section */}\n        <div className=\"p-4 md:p-6 border-b bg-card\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div className=\"flex items-center gap-3\">\n              <DollarSign className=\"w-8 h-8 text-primary\" />\n              <div>\n                <h1 className=\"font-serif text-2xl md:text-3xl font-bold\">Refund Management</h1>\n                <p className=\"text-sm text-muted-foreground\">Manage customer refund requests</p>\n              </div>\n            </div>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={() => refetch()}\n              className=\"gap-2\"\n            >\n              <RefreshCw className=\"w-4 h-4\" />\n              Refresh\n            </Button>\n          </div>\n          \n          {/* Search Bar */}\n          <div className=\"mb-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n              <Input\n                type=\"text\"\n                placeholder=\"Search by order number, customer name, or phone...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10 w-full\"\n              />\n            </div>\n          </div>\n          \n          {/* Status Filters */}\n          <div className=\"flex gap-2 overflow-x-auto pb-2\">\n            {statusFilters.map((status) => (\n              <Badge\n                key={status}\n                variant={selectedStatus === status ? \"default\" : \"secondary\"}\n                className=\"cursor-pointer whitespace-nowrap px-3 py-1.5 text-xs md:px-4 md:py-2 md:text-sm hover-elevate flex-shrink-0\"\n                onClick={() => setSelectedStatus(status)}\n              >\n                {status}\n              </Badge>\n            ))}\n          </div>\n        </div>\n\n        {/* Refunds Table */}\n        <div className=\"flex-1 overflow-y-auto p-4 md:p-6\">\n          {isLoading ? (\n            <div className=\"space-y-4\">\n              {[1, 2, 3].map((i) => (\n                <Card key={i} className=\"overflow-hidden\">\n                  <CardContent className=\"p-4\">\n                    <div className=\"h-6 bg-muted rounded animate-pulse mb-2\" />\n                    <div className=\"h-4 bg-muted rounded animate-pulse\" />\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          ) : filteredRefunds.length === 0 ? (\n            <Card>\n              <CardContent className=\"p-12 text-center\">\n                <AlertCircle className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">No Refunds Found</h3>\n                <p className=\"text-muted-foreground\">\n                  {searchQuery || selectedStatus !== \"All\" \n                    ? \"No refunds match your search criteria.\"\n                    : \"No refund requests at the moment.\"}\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            <Card>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Order #</TableHead>\n                    <TableHead>Customer</TableHead>\n                    <TableHead>Phone</TableHead>\n                    <TableHead className=\"text-right\">Amount</TableHead>\n                    <TableHead>Reason</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Requested</TableHead>\n                    <TableHead className=\"text-center\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {filteredRefunds.map((refund) => (\n                    <TableRow key={refund.id} className=\"cursor-pointer hover:bg-muted/50\">\n                      <TableCell className=\"font-medium\">\n                        #{refund.orderNumber}\n                      </TableCell>\n                      <TableCell>{refund.order?.customerName || 'N/A'}</TableCell>\n                      <TableCell>{refund.order?.customerPhone || 'N/A'}</TableCell>\n                      <TableCell className=\"text-right font-semibold\">\n                        â‚¦{parseFloat(refund.amount).toLocaleString()}\n                      </TableCell>\n                      <TableCell className=\"max-w-xs truncate\">\n                        {refund.reason}\n                      </TableCell>\n                      <TableCell>{getStatusBadge(refund.status)}</TableCell>\n                      <TableCell className=\"text-sm text-muted-foreground\">\n                        {new Date(refund.createdAt).toLocaleDateString()}\n                      </TableCell>\n                      <TableCell className=\"text-center\">\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => {\n                            setSelectedRefund(refund);\n                            setShowRefundDialog(true);\n                          }}\n                        >\n                          View Details\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </Card>\n          )}\n        </div>\n      </div>\n\n      {/* Refund Detail Dialog */}\n      <Dialog open={showRefundDialog} onOpenChange={setShowRefundDialog}>\n        <DialogContent className=\"max-w-2xl\">\n          {selectedRefund && (\n            <>\n              <DialogHeader>\n                <DialogTitle className=\"flex items-center gap-2\">\n                  <DollarSign className=\"w-5 h-5 text-primary\" />\n                  Refund Request - Order #{selectedRefund.orderNumber}\n                </DialogTitle>\n                <DialogDescription>\n                  Review and process this refund request\n                </DialogDescription>\n              </DialogHeader>\n\n              <div className=\"space-y-4\">\n                {/* Refund Information */}\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-base\">Refund Information</CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-3\">\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Amount</p>\n                        <p className=\"text-lg font-bold text-primary\">\n                          â‚¦{parseFloat(selectedRefund.amount).toLocaleString()}\n                        </p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Status</p>\n                        <div className=\"mt-1\">{getStatusBadge(selectedRefund.status)}</div>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Requested By</p>\n                        <p className=\"font-medium\">{selectedRefund.requestedBy}</p>\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Requested On</p>\n                        <p className=\"font-medium\">\n                          {new Date(selectedRefund.createdAt).toLocaleString()}\n                        </p>\n                      </div>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground mb-1\">Reason</p>\n                      <p className=\"text-sm bg-muted p-3 rounded-lg\">{selectedRefund.reason}</p>\n                    </div>\n                    {selectedRefund.processedBy && (\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Processed By</p>\n                        <p className=\"font-medium\">{selectedRefund.processedBy}</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                {/* Order Information */}\n                {selectedRefund.order && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">Order Details</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Customer</p>\n                          <p className=\"font-medium\">{selectedRefund.order.customerName}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Phone</p>\n                          <p className=\"font-medium\">{selectedRefund.order.customerPhone}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Order Type</p>\n                          <p className=\"font-medium capitalize\">{selectedRefund.order.orderType}</p>\n                        </div>\n                        <div>\n                          <p className=\"text-sm text-muted-foreground\">Payment Method</p>\n                          <p className=\"font-medium capitalize\">{selectedRefund.order.paymentMethod}</p>\n                        </div>\n                      </div>\n                      \n                      {/* Order Items */}\n                      <div>\n                        <p className=\"text-sm text-muted-foreground mb-2\">Items</p>\n                        <div className=\"space-y-2\">\n                          {selectedRefund.order.items.map((item) => (\n                            <div key={item.id} className=\"flex justify-between items-center bg-muted p-2 rounded\">\n                              <div>\n                                <p className=\"font-medium text-sm\">{item.menuItem.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">Qty: {item.quantity}</p>\n                              </div>\n                              <p className=\"font-semibold\">\n                                â‚¦{(parseFloat(item.price) * item.quantity).toLocaleString()}\n                              </p>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n\n                {/* Action Section - Only show for pending refunds */}\n                {selectedRefund.status === 'pending' && (\n                  <Card className=\"border-primary/20\">\n                    <CardHeader>\n                      <CardTitle className=\"text-base\">Process Refund</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <div>\n                        <label className=\"text-sm font-medium mb-2 block\">\n                          Rejection Reason (if rejecting)\n                        </label>\n                        <Textarea\n                          placeholder=\"Enter reason for rejection...\"\n                          value={refundReason}\n                          onChange={(e) => setRefundReason(e.target.value)}\n                          className=\"resize-none\"\n                          rows={3}\n                        />\n                      </div>\n                      \n                      <div className=\"flex gap-3\">\n                        <Button\n                          variant=\"default\"\n                          className=\"flex-1 bg-green-600 hover:bg-green-700\"\n                          onClick={() => handleApproveRefund(selectedRefund.id)}\n                          disabled={processingRefund}\n                        >\n                          <CheckCircle className=\"w-4 h-4 mr-2\" />\n                          {processingRefund ? \"Processing...\" : \"Approve Refund\"}\n                        </Button>\n                        <Button\n                          variant=\"destructive\"\n                          className=\"flex-1\"\n                          onClick={() => handleRejectRefund(selectedRefund.id, refundReason)}\n                          disabled={processingRefund || !refundReason.trim()}\n                        >\n                          <XCircle className=\"w-4 h-4 mr-2\" />\n                          {processingRefund ? \"Processing...\" : \"Reject Refund\"}\n                        </Button>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n\n              <DialogFooter>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setShowRefundDialog(false);\n                    setSelectedRefund(null);\n                    setRefundReason(\"\");\n                  }}\n                >\n                  Close\n                </Button>\n              </DialogFooter>\n            </>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n